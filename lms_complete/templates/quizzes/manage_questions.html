{% extends 'base.html' %}

{% block title %}Manage Questions - {{ quiz.title }} - EduFlow{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 2rem auto;">
    <!-- Header -->
    <div style="background: linear-gradient(135deg, #8b5cf6, #14b8a6); border-radius: 20px; padding: 2rem; color: white; margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">Manage Questions</h1>
                <p style="opacity: 0.9;">{{ quiz.title }} - {{ quiz.lesson.course.title }} / {{ quiz.lesson.title }}</p>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <a href="{% url 'quizzes:edit_quiz' quiz.id %}" 
                   style="background: rgba(255,255,255,0.2); color: white; padding: 0.75rem 1.5rem; border-radius: 50px; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-edit"></i> Edit Quiz
                </a>
                <a href="{% url 'quizzes:manage_quizzes' quiz.lesson.id %}" 
                   style="background: rgba(255,255,255,0.2); color: white; padding: 0.75rem 1.5rem; border-radius: 50px; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
        </div>
        
        <!-- Quiz Stats -->
        <div style="display: flex; gap: 2rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.2);">
            <div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Total Questions</div>
                <div style="font-weight: 700; font-size: 1.2rem;">{{ questions|length }}</div>
            </div>
            <div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Total Points</div>
                <div style="font-weight: 700; font-size: 1.2rem;">{{ quiz.total_points }}</div>
            </div>
            <div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Passing Score</div>
                <div style="font-weight: 700; font-size: 1.2rem;">{{ quiz.passing_score }}%</div>
            </div>
        </div>
    </div>

    <!-- Add Question Button -->
    <div style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="font-size: 1.3rem; font-weight: 600; color: #0f172a;">Questions List</h2>
        <a href="{% url 'quizzes:add_question' quiz.id %}" 
           style="background: #8b5cf6; color: white; padding: 0.75rem 2rem; border-radius: 50px; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 500; transition: all 0.3s;"
           onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 25px rgba(139, 92, 246, 0.3)';"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            <i class="fas fa-plus-circle"></i> Add New Question
        </a>
    </div>

    <!-- Questions List -->
    {% if questions %}
    <div id="question-list" style="display: flex; flex-direction: column; gap: 1rem;">
        {% for question in questions %}
        <div class="question-item" data-id="{{ question.id }}" 
             style="background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 8px 30px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; transition: all 0.3s; cursor: move;">
            
            <!-- Question Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="background: #8b5cf6; color: white; width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                        {{ question.order }}
                    </div>
                    <div>
                        <h3 style="font-weight: 600; color: #0f172a; margin-bottom: 0.25rem;">{{ question.text|truncatechars:100 }}</h3>
                        <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: #64748b;">
                            <span><i class="fas fa-star" style="color: #fbbf24;"></i> {{ question.points }} points</span>
                            <span><i class="fas fa-check-circle" style="color: #10b981;"></i> Correct: Option {{ question.correct_answer }}</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <a href="{% url 'quizzes:edit_question' question.id %}" 
                       style="background: #f1f5f9; color: #334155; padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.25rem;"
                       onmouseover="this.style.background='#8b5cf6'; this.style.color='white';"
                       onmouseout="this.style.background='#f1f5f9'; this.style.color='#334155';">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <button onclick="deleteQuestion({{ question.id }})" 
                            style="background: #fee2e2; color: #ef4444; padding: 0.5rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.25rem;"
                            onmouseover="this.style.background='#ef4444'; this.style.color='white';"
                            onmouseout="this.style.background='#fee2e2'; this.style.color='#ef4444';">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
            
            <!-- Options Grid -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                <!-- Option A -->
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: {% if question.correct_answer == 'A' %}#d1fae5{% else %}#f8fafd{% endif %}; border-radius: 8px;">
                    <span style="width: 24px; height: 24px; border-radius: 50%; background: {% if question.correct_answer == 'A' %}#10b981{% else %}#e2e8f0{% endif %}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600;">
                        A
                    </span>
                    <span style="flex: 1; color: #334155;">{{ question.option_a }}</span>
                    {% if question.correct_answer == 'A' %}
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                    {% endif %}
                </div>
                
                <!-- Option B -->
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: {% if question.correct_answer == 'B' %}#d1fae5{% else %}#f8fafd{% endif %}; border-radius: 8px;">
                    <span style="width: 24px; height: 24px; border-radius: 50%; background: {% if question.correct_answer == 'B' %}#10b981{% else %}#e2e8f0{% endif %}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600;">
                        B
                    </span>
                    <span style="flex: 1; color: #334155;">{{ question.option_b }}</span>
                    {% if question.correct_answer == 'B' %}
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                    {% endif %}
                </div>
                
                <!-- Option C (if exists) -->
                {% if question.option_c %}
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: {% if question.correct_answer == 'C' %}#d1fae5{% else %}#f8fafd{% endif %}; border-radius: 8px;">
                    <span style="width: 24px; height: 24px; border-radius: 50%; background: {% if question.correct_answer == 'C' %}#10b981{% else %}#e2e8f0{% endif %}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600;">
                        C
                    </span>
                    <span style="flex: 1; color: #334155;">{{ question.option_c }}</span>
                    {% if question.correct_answer == 'C' %}
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Option D (if exists) -->
                {% if question.option_d %}
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: {% if question.correct_answer == 'D' %}#d1fae5{% else %}#f8fafd{% endif %}; border-radius: 8px;">
                    <span style="width: 24px; height: 24px; border-radius: 50%; background: {% if question.correct_answer == 'D' %}#10b981{% else %}#e2e8f0{% endif %}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600;">
                        D
                    </span>
                    <span style="flex: 1; color: #334155;">{{ question.option_d }}</span>
                    {% if question.correct_answer == 'D' %}
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <!-- Explanation (if exists) -->
            {% if question.explanation %}
            <div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 8px; color: #0369a1; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> {{ question.explanation }}
            </div>
            {% endif %}
            
            <!-- Drag Handle Indicator -->
            <div style="margin-top: 0.5rem; text-align: center; color: #94a3b8; font-size: 0.8rem;">
                <i class="fas fa-grip-vertical"></i> Drag to reorder
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Reorder Instructions -->
    <div style="margin-top: 2rem; padding: 1rem; background: #f1f5f9; border-radius: 12px; color: #475569; display: flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-info-circle" style="color: #8b5cf6;"></i>
        <span>Drag questions up and down to reorder them. The order determines how students see the questions.</span>
    </div>

    {% else %}
    <!-- Empty State -->
    <div style="text-align: center; padding: 4rem; background: white; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.05);">
        <i class="fas fa-question-circle" style="font-size: 4rem; color: #cbd5e1; margin-bottom: 1rem;"></i>
        <h2 style="font-size: 1.5rem; color: #334155; margin-bottom: 0.5rem;">No Questions Yet</h2>
        <p style="color: #64748b; margin-bottom: 2rem;">Start adding multiple choice questions to your quiz</p>
        <a href="{% url 'quizzes:add_question' quiz.id %}" 
           style="display: inline-block; background: #8b5cf6; color: white; padding: 1rem 2rem; border-radius: 50px; text-decoration: none; font-weight: 600;">
            <i class="fas fa-plus-circle"></i> Add Your First Question
        </a>
    </div>
    {% endif %}
</div>

<!-- Include SortableJS for drag and drop reordering -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
    // Initialize drag and drop
    const questionList = document.getElementById('question-list');
    if (questionList) {
        const sortable = new Sortable(questionList, {
            animation: 150,
            handle: '.question-item',
            onEnd: function(evt) {
                // Get the new order
                const items = document.querySelectorAll('.question-item');
                const order = [];
                items.forEach(item => {
                    order.push(item.dataset.id);
                });
                
                // Send the new order to server
                fetch('{% url "quizzes:reorder_questions" quiz.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify({
                        order: order
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update order numbers in display
                        items.forEach((item, index) => {
                            const orderBadge = item.querySelector('div[style*="background: #8b5cf6; color: white;"]');
                            if (orderBadge) {
                                orderBadge.textContent = index + 1;
                            }
                        });
                        
                        // Show success message (optional)
                        console.log('Order updated successfully');
                    }
                });
            }
        });
    }

    // Delete question function
    function deleteQuestion(questionId) {
        if (confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
            fetch(`/quizzes/question/${questionId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the question element from DOM
                    const questionElement = document.querySelector(`.question-item[data-id="${questionId}"]`);
                    questionElement.remove();
                    
                    // Show success message (optional)
                    alert('Question deleted successfully');
                    
                    // Reload page if no questions left
                    if (document.querySelectorAll('.question-item').length === 0) {
                        location.reload();
                    }
                } else {
                    alert('Error deleting question');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting question');
            });
        }
    }
</script>

<style>
    .question-item {
        transition: all 0.3s;
    }
    
    .question-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.1) !important;
        border-color: #8b5cf6 !important;
    }
    
    .question-item:active {
        cursor: grabbing;
        opacity: 0.8;
    }
    
    @media (max-width: 768px) {
        div[style*="grid-template-columns: repeat(2, 1fr)"] {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}